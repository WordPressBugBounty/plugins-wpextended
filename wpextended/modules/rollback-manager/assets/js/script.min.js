class RollbackManager{constructor(){this.elements={typeSelect:document.querySelector("#type"),pluginSelect:document.querySelector("#plugin_list"),themeSelect:document.querySelector("#theme_list"),versionSelect:document.querySelector("#version_list"),rollbackButton:document.querySelector("#rollback_button"),rollbackButtonText:document.querySelector("#rollback_button .wpext-button__text")},this.data={plugins:{},themes:{},versions:{}},this.urlParams=new URLSearchParams(window.location.search),this.type=this.urlParams.get("type"),this.name=this.urlParams.get("name"),this.init()}init(){this.elements.versionSelect&&(this.elements.versionSelect.disabled=!0),this.fetchItems(),this.bindEvents()}bindEvents(){this.elements.typeSelect&&this.elements.typeSelect.addEventListener("change",this.handleTypeChange.bind(this)),this.elements.pluginSelect&&this.elements.pluginSelect.addEventListener("change",this.handleItemChange.bind(this)),this.elements.themeSelect&&this.elements.themeSelect.addEventListener("change",this.handleItemChange.bind(this)),this.elements.versionSelect&&this.elements.versionSelect.addEventListener("change",this.handleVersionChange.bind(this)),this.elements.rollbackButton&&this.elements.rollbackButton.addEventListener("click",this.handleRollback.bind(this))}fetchItems(){this.showLoading(this.elements.pluginSelect),this.showLoading(this.elements.themeSelect),fetch(rollbackData.restUrl+"/rollback-manager/get-items",{method:"GET",headers:{"X-WP-Nonce":rollbackData.restNonce,"Content-Type":"application/json"}}).then((e=>{if(!e.ok)throw Error("HTTP error "+e.status);return e.json()})).then((e=>{e.success?(this.data.plugins=e.data.plugins||{},this.data.themes=e.data.themes||{},this.populateItemSelects(),this.type&&this.name&&this.handleUrlParameters()):window.notify.error(rollbackData.i18n.errorFetchingItems)})).catch((e=>{console.error("Fetch error:",e),window.notify.error(rollbackData.i18n.errorFetchingItems)})).finally((()=>{this.hideLoading(this.elements.pluginSelect),this.hideLoading(this.elements.themeSelect)}))}handleUrlParameters(){"plugin"===this.type?(this.elements.typeSelect.value="plugin",this.elements.pluginSelect.value=this.name,this.handleItemChange()):"theme"===this.type&&(this.elements.typeSelect.value="theme",this.elements.themeSelect.value=this.name,this.handleItemChange())}populateItemSelects(){if(this.elements.pluginSelect){this.elements.pluginSelect.innerHTML="";const e=document.createElement("option");e.value="empty",e.textContent=rollbackData.i18n.selectPlugin,this.elements.pluginSelect.appendChild(e),Object.entries(this.data.plugins).forEach((([e,t])=>{const l=document.createElement("option");l.value=e,l.textContent=t.name||t,t.file&&(l.dataset.pluginFile=t.file),this.elements.pluginSelect.appendChild(l)}))}if(this.elements.themeSelect){this.elements.themeSelect.innerHTML="";const e=document.createElement("option");e.value="empty",e.textContent=rollbackData.i18n.selectTheme,this.elements.themeSelect.appendChild(e),Object.entries(this.data.themes).forEach((([e,t])=>{const l=document.createElement("option");l.value=e,l.textContent=t.name||t,t.file&&(l.dataset.themeFile=t.file),this.elements.themeSelect.appendChild(l)}))}}handleTypeChange(){if(this.elements.typeSelect){if(this.elements.typeSelect.value,this.elements.versionSelect){this.elements.versionSelect.innerHTML="";const e=document.createElement("option");e.value="empty",e.textContent=rollbackData.i18n.selectVersion,this.elements.versionSelect.appendChild(e),this.elements.versionSelect.value="empty",this.elements.versionSelect.disabled=!0}this.elements.pluginSelect&&(this.elements.pluginSelect.value="empty"),this.elements.themeSelect&&(this.elements.themeSelect.value="empty"),this.elements.pluginSelect&&this.elements.pluginSelect.dispatchEvent(new Event("change")),this.elements.themeSelect&&this.elements.themeSelect.dispatchEvent(new Event("change"))}else console.error("Type select element not found")}handleItemChange(){if(!this.elements.typeSelect)return void console.error("Type select element not found");const e=this.elements.typeSelect.value;let t="";if("plugin"===e&&this.elements.pluginSelect?(t=this.elements.pluginSelect.value,this.elements.themeSelect&&(this.elements.themeSelect.value="empty")):"theme"===e&&this.elements.themeSelect&&(t=this.elements.themeSelect.value,this.elements.pluginSelect&&(this.elements.pluginSelect.value="empty")),this.elements.versionSelect){this.elements.versionSelect.innerHTML="";const e=document.createElement("option");e.value="empty",e.textContent=rollbackData.i18n.selectVersion,this.elements.versionSelect.appendChild(e),this.elements.versionSelect.value="empty",this.elements.versionSelect.disabled=!0}t&&"empty"!==t&&this.fetchVersions(e,t)}fetchVersions(e,t){e&&t&&(this.showLoading(this.elements.versionSelect),fetch(`${rollbackData.restUrl}/rollback-manager/get-versions?type=${e}&slug=${t}`,{method:"GET",headers:{"X-WP-Nonce":rollbackData.restNonce,"Content-Type":"application/json"}}).then((e=>{if(!e.ok)throw Error("HTTP error "+e.status);return e.json()})).then((e=>{e.success?(this.data.versions=e.data||[],this.populateVersionSelect()):window.notify.error(rollbackData.i18n.errorFetchingVersions)})).catch((e=>{console.error("Fetch error:",e),window.notify.error(rollbackData.i18n.errorFetchingVersions)})).finally((()=>{this.hideLoading(this.elements.versionSelect)})))}populateVersionSelect(){if(this.elements.versionSelect){this.elements.versionSelect.innerHTML="";const e=document.createElement("option");e.value="empty",e.textContent=rollbackData.i18n.selectVersion,this.elements.versionSelect.appendChild(e),this.data.versions&&this.data.versions.length>0?(this.data.versions.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,e.current&&(t.disabled=!0,t.textContent+=" (current)"),this.elements.versionSelect.appendChild(t)})),this.elements.versionSelect.disabled=!1):this.elements.versionSelect.disabled=!0}}handleVersionChange(){if(this.elements.rollbackButton){const e=this.elements.versionSelect.value;this.elements.rollbackButton.disabled=!e}}handleRollback(){const e=this.elements.typeSelect.value;let t="";"plugin"===e&&this.elements.pluginSelect?t=this.elements.pluginSelect.value:"theme"===e&&this.elements.themeSelect&&(t=this.elements.themeSelect.value);const l=this.elements.versionSelect.value;e&&t&&l?confirm(`Are you sure you want to rollback this ${e} to version ${l}? This action cannot be undone.`)&&this.performRollback(e,t,l):window.notify.error("Please select a type, item, and version.")}async performRollback(e,t,l){try{this.lockUI(!0),this.elements.rollbackButton&&this.elements.rollbackButtonText&&(this.elements.rollbackButton.disabled=!0,this.elements.rollbackButton.dataset.loading="true",this.elements.rollbackButtonText.textContent=rollbackData.i18n.rollingBack);const n=window.notify.info(`Rolling back ${e} to version ${l}...`,{closeButton:!1}),s={type:e,slug:t,version:l};if("plugin"===e&&this.elements.pluginSelect){const e=this.elements.pluginSelect.options[this.elements.pluginSelect.selectedIndex];e&&e.dataset.pluginFile&&(s.file=e.dataset.pluginFile)}else if("theme"===e&&this.elements.themeSelect){const e=this.elements.themeSelect.options[this.elements.themeSelect.selectedIndex];e&&e.dataset.themeFile&&(s.file=e.dataset.themeFile)}const i=await fetch(rollbackData.restUrl+"/rollback-manager/rollback",{method:"POST",headers:{"X-WP-Nonce":rollbackData.restNonce,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw Error("HTTP error "+i.status);const o=await i.json();if(n&&n.close(),!o.success)throw Error(o.message||"Failed to rollback "+e);window.notify.success(o.message||`Successfully rolled back ${e} to version ${l}`),setTimeout((()=>{window.location.reload()}),2e3)}catch(e){window.notify.error("Error during rollback: "+e.message)}finally{this.lockUI(!1),this.elements.rollbackButton&&this.elements.rollbackButtonText&&(this.elements.rollbackButton.disabled=!1,this.elements.rollbackButton.dataset.loading="false",this.elements.rollbackButtonText.textContent=rollbackData.i18n.rollback)}}showLoading(e){if(e&&(e.disabled=!0,e.classList.add("loading"),"SELECT"===e.tagName)){const t=e.value;e.innerHTML="";const l=document.createElement("option");l.value=t||"",l.textContent=rollbackData.i18n.loading,e.appendChild(l)}}hideLoading(e){e&&(e.disabled=!1,e.classList.remove("loading"))}lockUI(e){[this.elements.typeSelect,this.elements.pluginSelect,this.elements.themeSelect,this.elements.versionSelect,this.elements.rollbackButton].forEach((t=>{t&&(t.disabled=e)}))}}document.addEventListener("DOMContentLoaded",(function(){new RollbackManager}));