!function($){"use strict";class e{constructor(){this.initializeConfig(),this.cacheElements(),this.init()}initializeConfig(){this.classes={loading:"wpext-loading",sortable:"wpext-sortable-enabled",dragging:"wpext-dragging",list:"wpext-sortable-list",hierarchyGroup:"wpext-hierarchy-group",hiddenDuringDrag:"wpext-hidden-during-drag",primaryDrag:"wpext-primary-drag",childDrag:"wpext-child-drag",enhancedPlaceholder:"wpext-enhanced-placeholder"},this.dragState={startIndex:null,stopIndex:null,order:[],draggedItems:[],draggedElement:null,draggedLevel:0,draggedParent:0},this.isHierarchical=!1,this.sortable=null,this.snapConfig={lastSnapTime:0,throttle:150,lastPlaceholderPosition:null,sensitivity:50}}cacheElements(){this.elements={body:$("body"),container:$("#the-list"),screenPerPage:$(".screen-per-page"),currentPage:$(".current-page"),listTable:$("table.wp-list-table tbody")}}init(){this.validateEnvironment()&&(this.detectHierarchy(),this.setupSortable(),this.bindEvents())}validateEnvironment(){return!("undefined"==typeof wpextPostOrder||!wpextPostOrder.restUrl||!this.elements.container.length)}detectHierarchy(){const e=this.elements.container.find('tr[class*="level-"]').length>0;let t=!1;this.elements.container.find('tr[id^="post-"]').each(((e,r)=>{if(this.getItemParent($(r))>0)return t=!0,!1})),this.isHierarchical=e||t}bindEvents(){this.elements.listTable.addClass(this.classes.list)}setupSortable(){this.sortable=new Sortable(this.elements.container[0],{handle:"tr",filter:".no-items",preventOnFilter:!1,ghostClass:"wpext-ghost",chosenClass:"wpext-chosen",dragClass:"wpext-drag",draggable:'tr[id^="post-"]',onStart:e=>this.handleSortStart(e),onMove:e=>this.handleMove(e),onEnd:e=>this.handleSortEnd(e)}),this.elements.container.addClass(this.classes.sortable)}handleSortStart(e){this.dragState.startIndex=e.oldIndex,this.dragState.draggedElement=$(e.item),this.dragState.order=this.calculateOrder(),this.isHierarchical?this.setupHierarchicalDrag():this.dragState.draggedItems=[this.dragState.draggedElement],this.applyDragStyling()}setupHierarchicalDrag(){this.dragState.draggedLevel=this.getItemLevel(this.dragState.draggedElement),this.dragState.draggedParent=this.getItemParent(this.dragState.draggedElement),this.dragState.draggedItems=this.getHierarchyGroup(this.dragState.draggedElement),this.markHierarchyGroup(),this.hideChildrenDuringDrag()}applyDragStyling(){this.dragState.draggedItems.forEach(((e,t)=>{e.addClass(this.classes.dragging),e.addClass(0===t?this.classes.primaryDrag:this.classes.childDrag)}))}handleMove(e){return!this.isHierarchical||this.validateHierarchicalMove(e)}validateHierarchicalMove(e){const t=$(e.related),r=$(e.item);if(!t.length)return!0;const s=this.extractPostId(r),a=this.extractPostId(t);if(!s||!a)return!0;const i=this.getItemLevel(r),n=this.getItemParent(r),d=this.getItemLevel(t),o=this.getItemParent(t);return n===o&&i===d||0===i&&0===d||i===d&&!(n>0&&(!o||o!==n))&&(0!==n||0>=o)}handleSortEnd(e){this.dragState.stopIndex=e.newIndex,this.isHierarchical&&this.dragState.draggedItems.length>1&&this.moveHierarchyGroupAfterDrop(),this.showChildrenAfterDrag(),this.cleanupDragState(),this.dragState.startIndex!==this.dragState.stopIndex&&this.processReorder(),this.resetDragState()}moveHierarchyGroupAfterDrop(){if(1>=this.dragState.draggedItems.length)return;let e=this.dragState.draggedElement;this.dragState.draggedItems.slice(1).forEach(((t,r)=>{if(this.isValidElement(t)&&t.prev()[0]!==e[0])try{t.detach().insertAfter(e)}catch(e){}e=t}))}isValidElement(e){return e&&e.length&&document.contains(e[0])}cleanupDragState(){[this.classes.dragging,this.classes.primaryDrag,this.classes.childDrag,this.classes.hiddenDuringDrag,this.classes.enhancedPlaceholder].forEach((e=>{this.elements.container.find("."+e).removeClass(e)})),this.clearHierarchyGroup()}resetDragState(){this.dragState={startIndex:null,stopIndex:null,order:[],draggedItems:[],draggedElement:null,draggedLevel:0,draggedParent:0},this.snapConfig.lastSnapTime=0,this.snapConfig.lastPlaceholderPosition=null}getHierarchyGroup(e){const t=[e],r=this.getItemLevel(e);let s=e.next("tr");for(;s.length;)if(this.extractPostId(s)){if(r>=this.getItemLevel(s))break;this.isValidElement(s)&&t.push(s),s=s.next("tr")}else s=s.next("tr");return t}getItemLevel(e){const t=e.attr("class")||"",r=[/level-(\d+)/,/post-level-(\d+)/,/hierarchy-level-(\d+)/];for(const e of r){const r=t.match(e);if(r)return parseInt(r[1],10)}return this.calculateLevelFromParents(e)}calculateLevelFromParents(e,t=new Set){const r=this.extractPostId(e);if(t.has(r))return 0;t.add(r);const s=this.getItemParent(e);if(0===s)return 0;const a=this.elements.container.find("#post-"+s);return a.length?this.calculateLevelFromParents(a,t)+1:1}getItemParent(e){const t=this.extractPostId(e);if(!t)return 0;const r=e.find(`#inline_${t} .post_parent`).text().trim();return r?parseInt(r,10):0}hasChildren(e){const t=parseInt(this.extractPostId(e),10);return!!t&&this.elements.container.find("tr").filter(((e,r)=>this.getItemParent($(r))===t)).length>0}markHierarchyGroup(){this.dragState.draggedItems.slice(1).forEach((e=>{this.isValidElement(e)&&e.addClass(this.classes.hierarchyGroup)}))}clearHierarchyGroup(){this.elements.container.find("."+this.classes.hierarchyGroup).removeClass(this.classes.hierarchyGroup)}hideChildrenDuringDrag(){this.dragState.draggedItems.slice(1).forEach((e=>{this.isValidElement(e)&&e.addClass(this.classes.hiddenDuringDrag)}))}showChildrenAfterDrag(){this.dragState.draggedItems.slice(1).forEach((e=>{e&&e.hasClass(this.classes.hiddenDuringDrag)&&e.removeClass(this.classes.hiddenDuringDrag)}))}calculateOrder(){const e=parseInt(this.elements.screenPerPage.val(),10)||20,t=parseInt(this.elements.currentPage.val(),10)||1,r=[];return this.elements.container.children().not(".ui-sortable-placeholder").each((function(s){const a=(t-1)*e;r.push(t>1?s+1+a:s+1)})),r}processReorder(){const e=[];if(this.elements.container.children("tr").not(".ui-sortable-placeholder").each(((t,r)=>{const s=$(r),a=this.extractPostId(s);if(a){const r=this.dragState.order[t]||t+1;e.push({id:parseInt(a,10),order:r})}})),0===e.length)throw this.showErrorNotification("Failed to prepare items for reordering. No valid items found."),Error("No items found to reorder");this.updatePostOrder(e)}extractPostId(e){const t=e.attr("id");return t?t.replace(/^\D+/g,""):null}updatePostOrder(e){const t=wpextPostOrder.restUrl+"/post-order/reorder";this.showLoadingIndicator(),fetch(t,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":wpextPostOrder.restNonce},body:JSON.stringify({items:e})}).then((e=>{if(!e.ok){if(400===e.status)return e.json().then((e=>{throw Error("Validation error: "+(e.message||"Invalid request"))})).catch((()=>{throw Error("HTTP error! status: "+e.status)}));throw Error("HTTP error! status: "+e.status)}return e.json()})).then((e=>this.handleUpdateResponse(e))).catch((e=>this.handleUpdateError(e))).finally((()=>this.hideLoadingIndicator()))}handleUpdateResponse(e){if(!e.success||!e.data)return void this.showErrorNotification(this.i18n("error"));const{updated:t,errors:r,post_type_label:s}=e.data;if(!t||0===t.length)return this.revertOrderChanges(),void this.showErrorNotification("Invalid move detected.");if(t.length>0){const e=s||"Items",t=this.i18n("order_updated",e);this.showSuccessNotification(t)}r&&r.length>0&&r.forEach((e=>{this.showErrorNotification(this.i18n("error_item",e.id,e.message))}))}handleUpdateError(e){this.revertOrderChanges();let t="Failed to update post order. ";e.message?.startsWith("Validation error:")?t=e.message.replace("Validation error: ",""):e.message?.includes("HTTP error")?t+="Server responded with an error. Please check your permissions and try again.":e.message?.includes("Failed to fetch")?t+="Network connection failed. Please check your internet connection and try again.":e.message?.includes("timeout")?t+="Request timed out. Please try again.":t+="Please try again or contact support if the problem persists.",this.showErrorNotification(t)}revertOrderChanges(){if(this.dragState.draggedElement&&null!==this.dragState.startIndex)try{if(this.revertToOriginalPosition(this.dragState.draggedElement),this.dragState.draggedItems.length>1){const e=this.dragState.draggedItems[0];this.dragState.draggedItems.slice(1).forEach((t=>{this.isValidElement(t)&&this.isValidElement(e)&&e.after(t)}))}}catch(e){}finally{this.cleanupDragState()}}revertToOriginalPosition(e){const t=this.elements.container.children("tr").not(".ui-sortable-placeholder").eq(this.dragState.startIndex);t.length&&null!==this.dragState.startIndex&&(0===this.dragState.startIndex?this.elements.container.prepend(e):t.after(e))}showLoadingIndicator(){$("#"+this.classes.loading).length||this.elements.body.append(`<div id="${this.classes.loading}" class="${this.classes.loading}">${this.i18n("updating")}</div>`)}hideLoadingIndicator(){$("#"+this.classes.loading).remove()}showSuccessNotification(e){window.notify?.success&&window.notify.success(e)}showErrorNotification(e){window.notify?.error?window.notify.error(e):alert("Error: "+e)}i18n(e,...t){if(!wpextPostOrder?.i18n?.[e])return e;let r=wpextPostOrder.i18n[e];return t.length>0&&t.forEach((e=>{r=r.replace("%s",e)})),r}}$(document).ready((()=>{new e}))}(jQuery);