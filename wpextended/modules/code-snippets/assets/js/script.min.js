class WpextendedCodeSnippets{constructor(){this.CONFIG={MODE_MAP:{php:"php",js:"javascript",css:"css",html:"htmlmixed"},MIME_TYPE_MAP:{php:"application/x-httpd-php-open",js:"application/javascript",css:"text/css",html:"text/html"},DEFAULT_RUN_LOCATIONS:{html:"wp_head",js:"wp_footer",css:"wp_head",php:"init"},SELECTORS:{form:"form",codeEditor:".CodeMirror",saveButton:'[data-action="save"]',deleteButton:'[data-action="delete"]',typeField:'[name="wpextended__code-snippets_settings[type]"]',codeField:'[name="wpextended__code-snippets_settings[code]"]',titleField:'[name="wpextended__code-snippets_settings[title]"]',enabledField:"#enabled_snippet",descriptionField:'[name="wpextended__code-snippets_settings[description]"]',gridTable:".wpext-table-container"}},this.maybeRedirectToList(),this.registerFormatters(),this.init()}maybeRedirectToList(){"list"!==wpextCodeSnippets.currentView&&(wpextCodeSnippets.isNew||wpextCodeSnippets.snippetId||(window.location.href=wpextCodeSnippets.listViewUrl))}registerFormatters(){window.snippetStatusFormatter=(e,t)=>{const i=t.cells[3].data,n=t.cells[0].data;return gridjs.html(`\n        <div class="wpext-module__toggle">\n          <input type="checkbox" class="wpext-module__checkbox" data-id="${n}" ${i?"checked":""}>\n          <label for="enabled_snippet" data-id="${n}">\n            <span class="screen-reader-text">Enable Snippet</span>\n          </label>\n        </div>`)},window.snippetActionsFormatter=(e,t)=>{const i=t.cells[0].data,n=new URL(window.location.href);return n.searchParams.set("snippet",i),gridjs.html(`<div style="display: inline;">\n        <button type="button" data-allow-default="true" onclick="window.location.href='${n.toString()}'" style="margin-right: 10px; background: none; border: none; cursor: pointer; padding: 0;"><span class="dashicons dashicons-edit"></span> ${wpextCodeSnippets.i18n.edit}</button>\n        <button type="button" data-action="delete" data-id="${i}" style="background: none; border: none; cursor: pointer; color: #dc3232; padding: 0;"><span class="dashicons dashicons-trash"></span> ${wpextCodeSnippets.i18n.delete}</button>\n      </div>`)}}init(){this.initCodeMirror(),this.initEventListeners(),this.initGridTable(),window.wpextendedCodeSnippets=this}initEventListeners(){document.addEventListener("click",(e=>this.handleClick(e))),document.addEventListener("change",(e=>this.handleChange(e)));const e=this.getElement(this.CONFIG.SELECTORS.form);e&&e.addEventListener("submit",(e=>{e.preventDefault(),this.handleSave()}))}initGridTable(){const e=this.getElement(this.CONFIG.SELECTORS.gridTable);e&&(e.addEventListener("click",(e=>{(e.target.matches(".wpext-module__checkbox")||e.target.matches(".wpext-module__toggle label"))&&this.handleGridToggle(e),e.target.matches('[data-action="delete"]')&&this.deleteSnippet(e)})),e.addEventListener("keydown",(e=>{e.target.matches(".wpext-module__checkbox")&&" "===e.key&&(e.preventDefault(),this.handleGridToggle(e))})))}async handleGridToggle(e){let t,i;if(e.target.matches(".wpext-module__checkbox")){t=e.target;const n=t.nextElementSibling;i=n?.dataset?.id}else{if(!e.target.matches(".wpext-module__toggle label"))return;t=e.target.previousElementSibling,i=e.target.dataset?.id}if(!i)return;const n=!t.checked;e.preventDefault(),this.performToggle(t,i,n)}async performToggle(e,t,i){try{const n=`${wpextCodeSnippets.restUrl}/code-snippets/snippets/${t}/toggle`,s=await this.makeApiRequest(n,"PUT",{enabled:i});s&&s.data&&"boolean"==typeof s.data.enabled&&(e.checked=s.data.enabled),window.notify.success(i?wpextCodeSnippets.i18n.enableSnippetSuccess:wpextCodeSnippets.i18n.disableSnippetSuccess)}catch(t){window.notify.error(t.message||wpextCodeSnippets.i18n.toggleSnippetError),e.checked=!i}}getElement(e){return document.querySelector(e)}getElements(e){return document.querySelectorAll(e)}handleClick(e){e.target.matches(this.CONFIG.SELECTORS.saveButton)?this.handleSave():e.target.matches(this.CONFIG.SELECTORS.deleteButton)&&this.deleteSnippet(e)}handleChange(e){e.target.matches(this.CONFIG.SELECTORS.typeField)&&this.updateCodeMirrorMode(e.target.value)}updateCodeMirrorMode(e){const t=this.getElements(this.CONFIG.SELECTORS.codeEditor);if(0===t.length)return;const i=this.CONFIG.MODE_MAP[e]||this.CONFIG.MODE_MAP.php,n=this.CONFIG.MIME_TYPE_MAP[e]||this.CONFIG.MIME_TYPE_MAP.php;t[0].CodeMirror.setOption("mode",i);const s=this.getElement(this.CONFIG.SELECTORS.codeField);s&&s.setAttribute("data-mimetype",n)}initCodeMirror(){if(0===this.getElements(this.CONFIG.SELECTORS.codeEditor).length)return;const e=this.getElement(this.CONFIG.SELECTORS.typeField),t=e?.value||"php";this.updateCodeMirrorMode(t)}getRunLocation(e,t){const i=`[name="wpextended__code-snippets_settings[${e}_run_location]"]`,n=t.querySelector(i);return n?.value||this.CONFIG.DEFAULT_RUN_LOCATIONS[e]||this.CONFIG.DEFAULT_RUN_LOCATIONS.php}getFormData(){const e=this.getElement(this.CONFIG.SELECTORS.form);if(!e)return window.notify.error(wpextCodeSnippets.i18n.formNotFound),null;const t=e.querySelector(this.CONFIG.SELECTORS.typeField),i=t?.value||"php";return{name:e.querySelector(this.CONFIG.SELECTORS.titleField)?.value||"",type:i,code:this.getCodeFromEditor()||e.querySelector('[name="code"]')?.value||"",enabled:e.querySelector(this.CONFIG.SELECTORS.enabledField)?.checked||!1,description:e.querySelector(this.CONFIG.SELECTORS.descriptionField)?.value||"",run_location:this.getRunLocation(i,e),is_valid:!0,priority:10}}getCodeFromEditor(){const e=this.getElements(this.CONFIG.SELECTORS.codeEditor);return e.length>0?e[0].CodeMirror.getValue():""}validateFormData(e){return e.name?!!e.code||(window.notify.error(wpextCodeSnippets.i18n.codeRequired),!1):(window.notify.error(wpextCodeSnippets.i18n.nameRequired),!1)}setButtonState(e,t,i,n){e&&(e.disabled=t,e.textContent=t?i:n,e.setAttribute("data-loading",t?"true":"false"))}async makeApiRequest(e,t,i=null){const n={method:t,headers:{"X-WP-Nonce":wpextCodeSnippets.nonce}};i&&(n.headers["Content-Type"]="application/json",n.body=JSON.stringify(i));const s=await fetch(e,n),o=await s.json();if(!s.ok)throw Error(o.message||"API request failed");return o}async handleSave(){const e=this.getFormData();if(!e||!this.validateFormData(e))return;const t=wpextCodeSnippets.isNew,i=t?wpextCodeSnippets.restUrl+"/code-snippets/snippets":`${wpextCodeSnippets.restUrl}/code-snippets/snippets/${wpextCodeSnippets.snippetId}`,n=this.getElement(this.CONFIG.SELECTORS.saveButton);this.setButtonState(n,!0,wpextCodeSnippets.i18n.saving,t?wpextCodeSnippets.i18n.createSnippet:wpextCodeSnippets.i18n.updateSnippet);try{const s=await this.makeApiRequest(i,t?"POST":"PUT",e);window.notify.success(t?wpextCodeSnippets.i18n.createSnippetSuccess:wpextCodeSnippets.i18n.updateSnippetSuccess),t&&s.data?.id&&this.handleNewSnippetSuccess(n,s.data.id)}catch(e){window.notify.error(e.message||wpextCodeSnippets.i18n.saveSnippetError)}finally{t||this.setButtonState(n,!1,wpextCodeSnippets.i18n.saving,wpextCodeSnippets.i18n.updateSnippet)}}handleNewSnippetSuccess(e,t){e&&(e.textContent=wpextCodeSnippets.i18n.updateSnippet),setTimeout((()=>{const e=new URL(window.location.href);e.searchParams.set("snippet",t),window.location.href=e.toString()}),1e3)}async deleteSnippet(e){if(e.preventDefault(),!confirm(wpextCodeSnippets.i18n.deleteSnippet))return;const t=e.target.dataset.id;if(t)try{await this.makeApiRequest(`${wpextCodeSnippets.restUrl}/code-snippets/snippets/${t}`,"DELETE"),window.notify.success(wpextCodeSnippets.i18n.deleteSnippetSuccess),window.location.reload()}catch(e){window.notify.error(e.message||wpextCodeSnippets.i18n.deleteSnippetError)}}}document.addEventListener("DOMContentLoaded",(()=>{new WpextendedCodeSnippets}));